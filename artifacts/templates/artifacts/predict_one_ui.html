<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Single Record Prediction — Primary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        .spinner {
            display: none
        }
    </style>
</head>
<body class="p-4">
<div class="container">
    <h3 class="mb-3">Predict One — Primary</h3>

    <div class="mb-3">
        <label class="form-label">Model</label>
        <select id="modelSelect" class="form-select">
            <option value="primary_rf">Primary — Random Forest</option>
            <option value="primary_logreg">Primary — Logistic Regression</option>
            <option value="primary_lstm">Primary — LSTM (P1–P5)</option>
        </select>
        <div class="form-text">RF/LR need P1–P6 + demographics. LSTM needs P1–P5 only.</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Decision Threshold: <span id="thVal">0.50</span></label>
        <input id="thSlider" type="range" class="form-range" min="0" max="1" step="0.01" value="0.50">
        <div class="form-text">Predict "Pass" when probability ≥ threshold.</div>
    </div>

    <div id="formFields" class="grid mb-3"></div>

    <div class="d-flex gap-2 mb-3">
        <button id="fillDemoBtn" class="btn btn-outline-secondary">Fill Demo</button>
        <button id="clearBtn" class="btn btn-outline-dark">Clear</button>
        <button id="predictBtn" class="btn btn-primary">Predict</button>
        <div id="spin" class="spinner-border spinner" role="status" style="width:1.5rem;height:1.5rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="msg" class="alert d-none"></div>

    <h5 class="mt-4">Response</h5>
    <div id="out" class="mono bg-light p-3 rounded border"></div>
</div>

<script>
    const PREDICT_ONE_URL = "{% url 'arti:predict_one' %}";
    const GET_SCHEMA_URL = PREDICT_ONE_URL;

    const CAT_CHOICES = {
        Gender: ["Male", "Female"],
        School_Location: ["Urban", "Rural"],
        Residence_Location: ["Urban", "Rural"],
        Has_Electricity: ["Yes", "No"],
        Parental_Education_Level: ["Primary", "Secondary", "Tertiary"]
    };

    function isScoreField(col) {
        return /_(P[1-6])$/.test(col);
    }

    let schema = null;

    async function loadSchema() {
        const res = await fetch(GET_SCHEMA_URL);
        schema = await res.json();
        buildFields();
    }

    function buildFields() {
        const model = document.getElementById("modelSelect").value;
        const req = schema?.required_columns?.[model] || [];
        const wrap = document.getElementById("formFields");
        wrap.innerHTML = "";

        req.forEach(col => {
            const group = document.createElement("div");
            const label = document.createElement("label");
            label.className = "form-label";
            label.textContent = col;
            let input;
            if (CAT_CHOICES[col]) {
                input = document.createElement("select");
                input.className = "form-select";
                CAT_CHOICES[col].forEach(opt => {
                    const o = document.createElement("option");
                    o.value = opt;
                    o.textContent = opt;
                    input.appendChild(o);
                });
            } else if (isScoreField(col)) {
                input = document.createElement("input");
                input.type = "number";
                input.step = "any";
                input.className = "form-control";
                input.placeholder = "e.g., 65";
            } else {
                input = document.createElement("input");
                input.type = "text";
                input.className = "form-control";
            }
            input.id = "fld__" + col;
            group.appendChild(label);
            group.appendChild(input);
            wrap.appendChild(group);
        });
    }

    document.getElementById("modelSelect").addEventListener("change", buildFields);

    const thSlider = document.getElementById("thSlider");
    const thVal = document.getElementById("thVal");
    thSlider.addEventListener("input", () => thVal.textContent = Number(thSlider.value).toFixed(2));

    function fillDemo() {
        const model = document.getElementById("modelSelect").value;
        const req = schema.required_columns[model];

        const demo = {
            Gender: "Male",
            School_Location: "Urban",
            Residence_Location: "Urban",
            Has_Electricity: "Yes",
            Parental_Education_Level: "Tertiary",
        };
        const grades = model === "primary_lstm" ? ["P1", "P2", "P3", "P4", "P5"] : ["P1", "P2", "P3", "P4", "P5", "P6"];
        const subjects = ["Kinyarwanda", "English", "Mathematics", "Science", "Social_Studies", "Creative_Arts"];
        let base = 60;
        grades.forEach((g, gi) => {
            subjects.forEach((s, si) => {
                demo[`${s}_${g}`] = base + gi + (si % 3);
            });
        });

        req.forEach(col => {
            const el = document.getElementById("fld__" + col);
            if (!el) return;
            el.value = demo[col] ?? el.value ?? "";
        });
    }

    document.getElementById("fillDemoBtn").addEventListener("click", (e) => {
        e.preventDefault();
        fillDemo();
    });

    function clearForm() {
        const inputs = document.querySelectorAll("#formFields input, #formFields select");
        inputs.forEach(i => i.value = "");
        showMsg("", "d-none");
        document.getElementById("out").innerHTML = "";
    }

    document.getElementById("clearBtn").addEventListener("click", (e) => {
        e.preventDefault();
        clearForm();
    });

    function showMsg(text, cls) {
        const m = document.getElementById("msg");
        m.className = "alert " + (cls || "alert-info");
        m.textContent = text || "";
        if (!text) m.classList.add("d-none");
        else m.classList.remove("d-none");
    }

    function collectPayload() {
        const model = document.getElementById("modelSelect").value;
        const req = schema.required_columns[model];
        const payload = {model, threshold: Number(thSlider.value)};
        const missing = [];
        req.forEach(col => {
            const el = document.getElementById("fld__" + col);
            if (!el || el.value === "") missing.push(col);
            else payload[col] = isScoreField(col) ? Number(el.value) : el.value;
        });
        return {payload, missing};
    }

    function renderResult(data) {
        const out = document.getElementById("out");
        const pct = Math.round(100 * data.prob);
        const labelClass = data.pred ? "bg-success" : "bg-danger";
        out.innerHTML = `
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="badge ${labelClass}">${data.label}</span>
          <span class="text-muted">Model: ${data.model}, τ=${Number(data.threshold).toFixed(2)}</span>
        </div>
        <div class="progress" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100" style="height:22px">
          <div class="progress-bar" style="width:${pct}%">${pct}% Pass prob</div>
        </div>
        <pre class="mono mt-3">${JSON.stringify(data, null, 2)}</pre>
      `;
    }

    async function doPredict() {
        showMsg("", "d-none");
        const spin = document.getElementById("spin");
        spin.style.display = "inline-block";

        const {payload, missing} = collectPayload();
        if (missing.length) {
            showMsg("Please fill required fields: " + missing.join(", "), "alert-warning");
            spin.style.display = "none";
            return;
        }
        try {
            const res = await fetch(PREDICT_ONE_URL, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || data.ok === false) {
                showMsg(data.error || "Prediction failed.", "alert-danger");
            } else {
                showMsg("Prediction completed.", "alert-success");
                renderResult(data);
            }
        } catch (err) {
            showMsg(err.message || String(err), "alert-danger");
        } finally {
            spin.style.display = "none";
        }
    }

    document.getElementById("predictBtn").addEventListener("click", (e) => {
        e.preventDefault();
        doPredict();
    });

    loadSchema();
</script>
</body>
</html>
